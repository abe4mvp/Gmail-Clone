<section  id="menu">
  <%= render :partial => 'option_buttons' %>
</section>

<section id="main" class="group">


  <section class="group" id="sidebar">
    <%= render :partial => 'sidebar' %>
    <br>
    <h2>AbeChat</h2>
    <ul id="contacts">
      <% @users.each do |user| %>
      <li><%= user.name %></li>
      <% end %>
    </ul>
  </section>

  <section id="mailbox">

  <%# render partial: 'email_box' %>

  </section>
</section>

<section id="new-email" class="invisible">
<%= render partial: "new_email" %>
</section>

<section class="i" id="chat">
  <ul id="chat-log">

  </ul>
  <form class="new-chat" action="<%= chats_url %>" method="post" data-remote="true">
    <input type="text" name="chat_text" id="chat-text" placeholder="Chat it up!">
    <input type="hidden" name="chat_to" value="" id="chat_to">
    <p><input type="submit" value="Chat &rarr;"></p>
  </form>

</section>


<input type="hidden" id="user_id" value="<%= current_user.id %>">

<script type="application/javascript" charset="utf-8" id="bootstrap-inbox">
  <%= render(file: 'messages/inbox.rabl', object: @messages, formats: :rabl).html_safe %>
</script>



<script src="http://js.pusher.com/2.1/pusher.min.js"></script>

<script>

$(document).ready(function(){

  $("form.new-chat").on("ajax:success", function(event){
      this.reset();



    });

    var pusher = new Pusher('<%= ENV["PUSHER_KEY"] %>');

    var me = $('#current-username')[0].innerText
    var currentUser = me.replace(' ', '-');


    //send outgoing chat
    $('#contacts').on("click", "li", function (event) {
      var outgoingName = $(event.currentTarget)[0].innerText.replace(' ', '-');


      $('#contacts').off(); // turn off chat for now
      // var namesArr = [outgoingName, currentUser];
      // var names = namesArr.sort().join(';');
      // var split = names.split(';');
      // var otherName = split[0] === currentUser ? split[1] : split[0];
      $('#chat_to')[0].value = outgoingName;


      //subscribe to your new chat
      var channel = pusher.subscribe(outgoingName);
      channel.bind('new_chat_message', function(data) {

        var prefixed = data;
        if (data.indexOf(me) === 4){
          prefixed = data.replace(me, "me");
        }

        $("#chat-log").append(prefixed);
      });

    });


    //listen for incoming messages
    var channel = pusher.subscribe(currentUser);
    channel.bind('new_chat_message', function(data) {
      $('#chat_to')[0].value = currentUser;

      var prefixed = data;
      if (data.indexOf(me) === 4){
        prefixed = data.replace(me, "me");
      }
      $("#chat-log").append(prefixed);
    });
});

</script>